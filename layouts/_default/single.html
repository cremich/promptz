{{ define "main" }}
  <!-- Condensed Hero Section -->
  <div
    class="relative overflow-hidden bg-gradient-to-br from-background via-background to-primary/5 border-b border-border/40"
  >
    <div
      class="absolute inset-0 bg-gradient-to-r from-primary/10 via-transparent to-accent/10"
    ></div>
    <div class="relative max-w-6xl mx-auto px-6 py-6">
      <div class="flex items-start justify-between">
        <div class="flex items-center gap-4 flex-1">
          {{ if eq .Section "prompts" }}
            <div
              class="p-3 rounded-xl bg-primary/10 border border-primary/20 text-primary"
            >
              {{ partial "icons/prompt.html" (dict "class" "w-6 h-6") }}
            </div>
          {{ else if eq .Section "rules" }}
            <div
              class="p-3 rounded-xl bg-primary/10 border border-primary/20 text-primary"
            >
              {{ partial "icons/shield-check.html" (dict "class" "w-6 h-6") }}
            </div>
          {{ else if eq .Section "agents" }}
            <div
              class="p-3 rounded-xl bg-primary/10 border border-primary/20 text-primary"
            >
              {{ partial "icons/desktop-computer.html" (dict "class" "w-6 h-6") }}
            </div>
          {{ else }}
            <div
              class="p-3 rounded-xl bg-primary/10 border border-primary/20 text-primary"
            >
              {{ partial "icons/document-text.html" (dict "class" "w-6 h-6") }}
            </div>
          {{ end }}
          <div class="flex-1">
            <h1
              class="text-3xl font-bold bg-gradient-to-r from-foreground to-foreground/70 bg-clip-text text-transparent"
            >
              {{ .Title }}
            </h1>
            <p class="text-muted-foreground mt-1">{{ .Description }}</p>
          </div>
        </div>
      </div>

      <!-- Tags and Metadata -->
      <div class="flex flex-wrap items-center gap-4 mt-4">
        {{ if .Params.tags }}
          <div class="flex flex-wrap gap-2">
            {{ range .Params.tags }}
              <a
                href="/tags/{{ . | urlize }}"
                class="badge text-violet-700 bg-violet-100 border-violet-200 dark:text-violet-300 dark:bg-violet-950 dark:border-violet-800"
              >
                #{{ . }}
              </a>
            {{ end }}
          </div>
        {{ end }}

        {{ if .Params.difficulty }}
          <span
            class="badge text-violet-700 bg-violet-100 border-violet-200 dark:text-violet-300 dark:bg-violet-950 dark:border-violet-800"
            >{{ .Params.difficulty }}</span
          >
        {{ end }}


        <!-- Date and author metadata -->
        {{ $createdDate := "" }}
        {{ $updatedDate := "" }}

        {{ if .Params.createdAt }}
          {{ $createdDate = .Params.createdAt }}
        {{ else if .GitInfo }}
          {{ $createdDate = .GitInfo.AuthorDate }}
        {{ end }}

        {{ if .Params.updatedAt }}
          {{ $updatedDate = .Params.updatedAt }}
        {{ else if .GitInfo }}
          {{ $updatedDate = .GitInfo.CommitDate }}
        {{ end }}

        {{ if or $createdDate $updatedDate }}
          <div
            class="flex items-center gap-2 text-sm text-muted-foreground ml-auto"
          >
            {{ with $createdDate }}
              <span>Created {{ (time .).Format "Jan 2, 2006" }}</span>
            {{ end }}
            {{ if and $createdDate $updatedDate }}
              <span>•</span>
            {{ end }}
            {{ with $updatedDate }}
              <span>Updated {{ (time .).Format "Jan 2, 2006" }}</span>
            {{ end }}
            {{ if $.Params.authors }}
              <span>•</span>
              <span>by {{ index $.Params.authors 0 }}</span>
            {{ else if $.Params.author }}
              <span>•</span>
              <span>by {{ $.Params.author }}</span>
            {{ else if $.GitInfo.AuthorName }}
              <span>•</span>
              <span>by {{ $.GitInfo.AuthorName }}</span>
            {{ end }}
          </div>
        {{ end }}
      </div>
    </div>
  </div>

  <!-- Breadcrumb Navigation -->
  <nav class="max-w-6xl mx-auto px-6 py-3 text-sm">
    <ol class="flex items-center gap-2 text-muted-foreground">
      <li><a href="/" class="hover:text-foreground">Home</a></li>
      <li>{{ partial "icons/chevron-right.html" (dict "class" "w-4 h-4") }}</li>
      <li>
        <a href="/{{ .Section }}" class="hover:text-foreground capitalize"
          >{{ .Section }}</a
        >
      </li>
      {{ with .Params.categories }}
        {{ range first 1 . }}
          <li>
            {{ partial "icons/chevron-right.html" (dict "class" "w-4 h-4") }}
          </li>
          <li>
            <a
              href="/{{ $.Section }}/{{ . | urlize }}"
              class="hover:text-foreground"
              >{{ . | title }}</a
            >
          </li>
        {{ end }}
      {{ end }}
      <li>{{ partial "icons/chevron-right.html" (dict "class" "w-4 h-4") }}</li>
      <li class="text-foreground">{{ .Title }}</li>
    </ol>
  </nav>

  <article class="max-w-6xl mx-auto px-6 py-8">
    <!-- Tab Navigation -->
    <div class="tabs w-full mb-6" id="content-tabs">
      <nav role="tablist" aria-orientation="horizontal" class="w-full">
        <button
          type="button"
          role="tab"
          id="content-tab"
          aria-controls="content-panel"
          aria-selected="true"
          tabindex="0"
        >
          {{ if eq .Section "prompts" }}
            Prompt
          {{ else if eq .Section "rules" }}
            Project Rule
          {{ else if eq .Section "agents" }}
            Agent Config
          {{ else }}
            Content
          {{ end }}
        </button>
        {{ with .Params.howToUse }}
          <button
            type="button"
            role="tab"
            id="howto-tab"
            aria-controls="howto-panel"
            aria-selected="false"
            tabindex="0"
          >
            How to Use
          </button>
        {{ end }}
        <button
          type="button"
          role="tab"
          id="installation-tab"
          aria-controls="installation-panel"
          aria-selected="false"
          tabindex="0"
        >
          Installation
        </button>
      </nav>

      <!-- Content Panel -->
      <div
        role="tabpanel"
        id="content-panel"
        aria-labelledby="content-tab"
        tabindex="-1"
        aria-selected="true"
      >
        <div class="card" id="main-content" data-pagefind-body>
          <div class="card-content prose prose-invert max-w-none px-4">
            {{ if eq .Section "agents" }}
              {{ $promptResource := .Resources.Get "prompt.md" }}
              {{ $configResource := .Resources.Get "agent.json" }}

              {{ .Content | safeHTML }}

              {{ if and $promptResource $configResource }}
                {{ $prompt := $promptResource.RawContent }}
                {{ $config := $configResource.Content | unmarshal }}
                {{ $config = merge $config (dict "prompt" $prompt) }}
                {{ $formattedJson := $config | jsonify (dict "indent" "  ") }}


                <h2>Agent Configuration</h2>

                <div data-copy="{{ $formattedJson }}">
                  <pre><code class="language-json">{{ $formattedJson }}</code></pre>
                </div>
              {{ end }}
            {{ else }}
              {{ .Content }}
            {{ end }}
          </div>
        </div>

        <!-- Source Reference -->
        {{ with .Params.sourceURL }}
          <div class="card mt-4">
            <div class="card-content">
              <div class="flex items-center gap-2 text-sm">
                <span class="font-medium">Source:</span>
                <a
                  href="{{ . }}"
                  target="_blank"
                  rel="noopener"
                  class="text-primary hover:text-primary/80 underline-offset-4 hover:underline break-all"
                >
                  {{ . }}
                </a>
              </div>
            </div>
          </div>
        {{ end }}

      </div>

      <!-- How to Use Panel -->
      {{ with .Params.howToUse }}
        <div
          role="tabpanel"
          id="howto-panel"
          aria-labelledby="howto-tab"
          tabindex="-1"
          aria-selected="false"
          hidden
        >
          <div class="card">
            <div class="card-content prose prose-invert max-w-none px-4">
              {{ . | markdownify }}
            </div>
          </div>
        </div>
      {{ end }}


      <!-- Installation Panel -->
      <div
        role="tabpanel"
        id="installation-panel"
        aria-labelledby="installation-tab"
        tabindex="-1"
        aria-selected="false"
        hidden
      >
        <div class="card px-4">
          <div class="card-content prose prose-invert max-w-none">
            {{ if eq .Section "prompts" }}
              <h3 class="text-lg font-medium mb-3">Install Prompt</h3>
              <p class="mb-4">
                Add this prompt to your Amazon Q CLI prompt library:
              </p>
              <div class="space-y-4">
                <div>
                  <h4 class="font-medium mb-2">
                    1. Download to local prompt library:
                  </h4>
                  <pre
                    class="bg-muted/50 p-3 rounded-md text-sm overflow-x-auto"
                  ><code>mkdir -p .amazonq/cli-prompts && curl -o .amazonq/cli-prompts/{{ .File.BaseFileName }}.md {{ .Permalink }}index.md</code></pre>
                </div>
                <div>
                  <h4 class="font-medium mb-2">2. Use with Q CLI:</h4>
                  <pre
                    class="bg-muted/50 p-3 rounded-md text-sm overflow-x-auto"
                  ><code>q prompts use {{ .File.BaseFileName }}</code></pre>
                </div>
              </div>
            {{ else if eq .Section "rules" }}
              <h3 class="text-lg font-medium mb-3">Install Project Rule</h3>
              <p class="mb-4">Add this rule to your project's context:</p>
              <div class="space-y-4">
                <div>
                  <h4 class="font-medium mb-2">
                    1. Download to project rules:
                  </h4>
                  <pre
                    class="bg-muted/50 p-3 rounded-md text-sm overflow-x-auto"
                  ><code>mkdir -p .amazonq/rules && curl -o .amazonq/rules/{{ .File.BaseFileName }}.md {{ .Permalink }}index.md</code></pre>
                </div>
              </div>
            {{ else if eq .Section "agents" }}
              <h3 class="text-lg font-medium mb-3">
                Install Agent Configuration
              </h3>
              <p class="mb-4">Add this agent to your Q CLI setup:</p>
              <div class="space-y-4">
                <div>
                  <h4 class="font-medium mb-2">1. Local agent:</h4>
                  <pre
                    class="bg-muted/50 p-3 rounded-md text-sm overflow-x-auto"
                  ><code>mkdir -p .amazonq/cli-agents && curl -o .amazonq/cli-agents/{{ .File.BaseFileName }}.json {{ .Permalink }}</code></pre>
                </div>
                <div>
                  <h4 class="font-medium mb-2">2. Activate agent:</h4>
                  <pre
                    class="bg-muted/50 p-3 rounded-md text-sm overflow-x-auto"
                  ><code>q chat --agent {{ .File.BaseFileName }}</code></pre>
                </div>
              </div>
            {{ end }}
          </div>
        </div>
      </div>
    </div>
  </article>

  <!-- Floating Action Buttons -->
  <div class="fixed bottom-6 right-6 flex flex-col gap-2 z-40">
    <button
      id="copy-content-floating"
      class="btn btn-primary shadow-lg"
      data-tooltip="Copy content"
      data-side="left"
    >
      {{ partial "icons/copy.html" }}
    </button>
    <button
      id="download-floating"
      class="btn btn-outline shadow-lg bg-background"
      data-tooltip="Download content"
      data-side="left"
    >
      {{ partial "icons/download.html" }}
    </button>
    <button
      id="share-floating"
      class="btn btn-outline shadow-lg bg-background"
      data-tooltip="Copy page URL"
      data-side="left"
    >
      {{ partial "icons/share.html" }}
    </button>
  </div>

  {{ partial "related-content.html" . }}


  <!-- Clipboard functionality -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Copy content functionality
  function copyContent() {
    // For custom agents, prioritize the JSON configuration
    const agentConfig = document.querySelector('[data-copy]');
    if (agentConfig) {
      const jsonContent = agentConfig.getAttribute('data-copy');
      return navigator.clipboard.writeText(jsonContent);
    }

    // For agents with JSON code blocks, extract just the JSON
    const codeBlock = document.querySelector('pre code.language-json');
    if (codeBlock) {
      // Get text content and remove line numbers
      const text = codeBlock.textContent || codeBlock.innerText;
      const cleanJson = text.replace(/^\s*\d+\s*/gm, '').trim();
      return navigator.clipboard.writeText(cleanJson);
    }

    // For other content, copy the main prose content
    const content = document.querySelector('#main-content .prose');
    const text = content ? (content.innerText || content.textContent) : '';
    return navigator.clipboard.writeText(text);
  }

  // Share URL functionality
  function shareUrl() {
    return navigator.clipboard.writeText(window.location.href);
  }

  // Download content functionality
  function downloadContent() {
    const section = '{{ .Section }}';
    const title = '{{ .Title }}';

    if (section === 'agents') {
      // Download JSON configuration for agents
      const agentConfig = document.querySelector('[data-copy]');
      if (agentConfig) {
        const jsonContent = agentConfig.getAttribute('data-copy');
        downloadFile(jsonContent, `${title.toLowerCase().replace(/\s+/g, '-')}.json`, 'application/json');
        return;
      }

      const codeBlock = document.querySelector('pre code.language-json');
      if (codeBlock) {
        const text = codeBlock.textContent || codeBlock.innerText;
        const cleanJson = text.replace(/^\s*\d+\s*/gm, '').trim();
        downloadFile(cleanJson, `${title.toLowerCase().replace(/\s+/g, '-')}.json`, 'application/json');
        return;
      }
    }

    // Download markdown content for prompts and rules
    const content = document.querySelector('#main-content .prose');
    const text = content ? (content.innerText || content.textContent) : '';
    downloadFile(text, `${title.toLowerCase().replace(/\s+/g, '-')}.md`, 'text/markdown');
  }

  function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // Success feedback
  function showSuccess(btn, originalText) {
    btn.innerHTML = '{{ partial "icons/check.html" }}';
    btn.classList.add('btn-success');
    setTimeout(() => {
      btn.innerHTML = originalText;
      btn.classList.remove('btn-success');
    }, 2000);
  }

  // Floating buttons
  const shareFloating = document.getElementById('share-floating');
  const copyFloating = document.getElementById('copy-content-floating');
  const downloadFloating = document.getElementById('download-floating');

  // Bind events
  [shareFloating].forEach(btn => {
    if (btn) {
      btn.addEventListener('click', async () => {
        try {
          await shareUrl();
          showSuccess(btn, '{{ partial "icons/share.html" }}');
        } catch (err) {
          console.error('Failed to copy URL:', err);
        }
      });
    }
  });

  [copyFloating].forEach(btn => {
    if (btn) {
      btn.addEventListener('click', async () => {
        try {
          await copyContent();
          showSuccess(btn, '{{ partial "icons/copy.html" }}');
        } catch (err) {
          console.error('Failed to copy content:', err);
        }
      });
    }
  });

  [downloadFloating].forEach(btn => {
    if (btn) {
      btn.addEventListener('click', () => {
        try {
          downloadContent();
          showSuccess(btn, '{{ partial "icons/download.html" }}');
        } catch (err) {
          console.error('Failed to download content:', err);
        }
      });
    }
  });
});
</script>
{{ end }}
